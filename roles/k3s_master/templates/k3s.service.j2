[Unit]
Description=Lightweight Kubernetes
Documentation=https://k3s.io
Wants=network-online.target
After=network-online.target

[Install]
WantedBy=multi-user.target

[Service]
Type=notify
EnvironmentFile=-/etc/default/%N
EnvironmentFile=-/etc/sysconfig/%N
EnvironmentFile=-/etc/systemd/system/k3s.service.env
KillMode=process
Delegate=yes
User=root
# Having non-zero Limit*s causes performance problems due to accounting overhead
# in the kernel. We recommend using cgroups to do container-local accounting.
LimitNOFILE=1048576
LimitNPROC=infinity
LimitCORE=infinity
TasksMax=infinity
TimeoutStartSec=0
Restart=always
RestartSec=5s
ExecStartPre=/bin/sh -xc '! /usr/bin/systemctl is-enabled --quiet nm-cloud-setup.service 2>/dev/null'
ExecStartPre=-/sbin/modprobe br_netfilter
ExecStartPre=-/sbin/modprobe overlay
ExecStart=/usr/local/bin/k3s \
    server \
	'--write-kubeconfig-mode' \
	'644' \
	'--node-name={{ inventory_hostname }}' \
	'--tls-san={{ k3s_domain }}' \
	'--tls-san={{ kube_vip_address }}' \
	'--node-external-ip' \
	'{{ ansible_host }}' \
	'--advertise-address' \
	'{{ ansible_host }}' \
	'--cluster-cidr' \
	'{{ cluster_cidr }}' \
	'--service-cidr' \
	'{{ service_cidr }}' \
	'--flannel-iface' \
	'{{ network_interface }}' \
	'--disable' \
	'servicelb' \
	'--disable' \
	'traefik' \
	'--node-taint' \
	'node-role.kubernetes.io/master=true:NoSchedule' \
	{% if cluster_init | default(false) %}'--cluster-init' \
{% else %}'--server' \
	'https://{{ kube_vip_address }}:6443' \
	'--token' \
	'{{ k3s_join_token }}' \{% endif %}
